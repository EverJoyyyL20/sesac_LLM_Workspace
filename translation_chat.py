#!pip install langchain streamlit openai

# -----------------------------------------
# Streamlit 웹 UI 라이브러리 불러오기
# -----------------------------------------
import streamlit as st
# → 웹 페이지 생성, 버튼, 입력창, 레이아웃 담당

# -----------------------------------------
# LangChain + OpenAI 챗 모델 클래스
# -----------------------------------------
from langchain_classic.chat_models import ChatOpenAI
# → GPT 모델을 LangChain에서 사용하기 위한 인터페이스

# -----------------------------------------
# 프롬프트 템플릿 클래스
# -----------------------------------------
from langchain_classic.prompts import PromptTemplate
# → 프롬프트 문자열을 변수 형태로 관리하기 위함

# -----------------------------------------
# LLMChain 클래스
# -----------------------------------------
from langchain_classic.chains import LLMChain
# → Prompt + LLM을 연결해서 실행 파이프라인 구성

# -----------------------------------------
# 대화 메모리 관리 클래스
# -----------------------------------------
from langchain_classic.memory import ConversationBufferMemory
# → 이전 대화/입력 기록 저장 (문맥 유지용)

# -----------------------------------------
# OS 환경변수 접근용 라이브러리
# -----------------------------------------
import os
# → 시스템 환경변수에서 API KEY 읽기

# -----------------------------------------
# .env 파일 환경변수 로드 라이브러리
# -----------------------------------------
from dotenv import load_dotenv
# → .env 파일의 내용을 환경변수로 등록

# -----------------------------------------
# .env 파일 로드 실행
# -----------------------------------------
load_dotenv()
# → OPENAI_API_KEY 같은 값들을 OS 환경변수로 불러옴


# -----------------------------------------
# OpenAI API KEY 가져오기
# -----------------------------------------
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
# → 시스템 환경변수에 저장된 키 값을 가져옴
# → 코드에 직접 키를 쓰지 않아서 보안에 안전


# -----------------------------------------
# 웹페이지에서 사용할 번역 언어 목록
# -----------------------------------------
langs = ["Korean", "Japanese", "chinese", "English"]
# → 사용자가 선택할 번역 대상 언어 리스트
# → 나중에 라디오 버튼에 사용됨

# -----------------------------------------
# 화면을 3칸 컬럼으로 분할
# -----------------------------------------
left_co, cent_co,last_co = st.columns(3)
# → 화면을 좌 / 중간 / 우 3구역으로 나눔
# → 대시보드 형태 UI 구성 가능


# -----------------------------------------
# 사이드바 영역 생성
# -----------------------------------------

# 웹페이지 왼쪽 사이드바 영역에 UI 배치
with st.sidebar:
     # 라디오 버튼 생성
     # 사용자가 하나의 언어를 선택
     language = st.radio('번역을 원하는 언어를 선택해주세요.:', langs)
      # → 선택된 값이 language 변수에 저장됨
     # 예: "Korean"

# -----------------------------------------
# 메인 화면 제목 출력
# -----------------------------------------
st.markdown('### 언어 번역 서비스예요~')

# → ### : HTML h3 크기 제목 표시


# -----------------------------------------
# 번역할 텍스트 입력창 생성
# -----------------------------------------
prompt = st.text_input('번역을 원하는 텍스트를 입력하세요')  #사용자의 텍스트 입력
# → 사용자가 번역할 문장 입력
# → 입력값이 prompt 변수에 저장됨


# -----------------------------------------
# 번역 프롬프트 템플릿 생성
# -----------------------------------------

trans_template = PromptTemplate(
     # LLM에 전달될 입력 변수 이름
    input_variables=['trans'],
    # 실제 GPT에게 전달할 명령 문장 템플릿
    # language 값은 위에서 선택한 언어
    # {trans} 는 실행 시 사용자 입력으로 치환됨
    template='Your task is to translate this text to ' + language + 'TEXT: {trans}'
)  #해당 서비스가 번역에 대한 것임을 지시
# → 이 프롬프트는 "번역 작업"임을 GPT에게 명확히 지시


# ---------------------------------------------
# ConversationBufferMemory 생성
# → 이전 입력과 결과를 자동으로 저장하는 메모리 객체
# ---------------------------------------------
memory = ConversationBufferMemory(# 체인 실행 시 입력으로 들어오는 변수 이름
                                  # 아래 trans_chain({'trans': prompt}) 와 연결됨
                                  input_key='trans', 
                                  # 메모리가 프롬프트 내부에서 사용될 변수 이름
                                   # LangChain 내부에서 "chat_history"라는 이름으로 저장됨
                                  memory_key='chat_history')


# ---------------------------------------------
# OpenAI GPT 모델 객체 생성
# ---------------------------------------------

    # 출력 결과의 랜덤성 조절
    # 0.0 → 항상 가장 안정적이고 정확한 결과 생성
    # 번역, 요약, QA 작업에 적합
llm = ChatOpenAI(temperature=0.0,
                  # 사용할 OpenAI 모델 이름
                 model_name='gpt-4.1-mini')

# ---------------------------------------------
# LangChain 실행 파이프라인(체인) 생성
# ---------------------------------------------
trans_chain = LLMChain(llm=llm,  # 사용할 GPT 모델 객체
                       prompt=trans_template,  # GPT에게 전달할 프롬프트 템플릿
                       verbose=True, # 실행 과정을 터미널(콘솔)에 출력
                                       # 디버깅용 옵션
                        # 체인 실행 결과를 딕셔너리에서 꺼낼 때 사용할 키 이름
                        # response['translate'] 형태로 접근 가능
                       output_key='translate', 
                        # 이전 번역 기록을 저장할 메모리 연결
                       memory=memory)


# ---------------------------------------------
# 번역 버튼 클릭 처리
# ---------------------------------------------

# 화면에 "번역" 버튼 생성
# 버튼 클릭 시 True 반환
if st.button("번역"):
     # 사용자가 입력한 텍스트가 비어있지 않을 때만 실행
    # (빈 입력 GPT 요청 방지)
    if prompt:
         # LangChain 체인 실행
        # {'trans': prompt} 형태로 입력 전달
        # → PromptTemplate의 {trans} 위치에 자동 삽입됨
        response = trans_chain({'trans': prompt})
        # 번역 결과 출력
        # st.info → 파란색 정보 박스 형태로 화면 표시
        st.info(response['translate'])